# 软键盘总结



在Android中，可以通过Activity设置windowSoftInputMode这个属性来控制软键盘来控制软键盘与Activity的主窗口的交互方式。

Activity的主窗口与包含屏幕软键盘的窗口的交互方式，该属性的设置影响两个方面：

1. 当Activity成为用户注意的焦点时软键盘的状态--隐藏还是可见
2. 在Activity主窗口所做的调整-意思是是否将其尺寸调小为软键盘腾出空间，或者当窗口部分被软键盘遮挡时是否平移其内容可以使当前焦点可见。

该设置必须时下面所列的值之一，或者是一个“state...”值加上一个“adjust...”值的组合，在任一组中设置多个值（例如：多个“state..”值）都会产生未定义结果。各值之间使用垂直条（｜）分隔。

1. 控制软键盘显示还是隐藏



|                    |                                                              |
| ------------------ | ------------------------------------------------------------ |
| stateUnspecified   | 不指定软键盘的状态（隐藏还是可见） 将由系统选择合适的状态，或依赖主题中的设置，这是对软键盘行为的默认设置 |
| stateUnchanged     | 保留状态 当 Activity 转至前台时保留软键盘最后所处的任何状态，无论是可见还是隐藏 |
| stateHidden        | 隐藏软键盘 当用户确实是向前导航到 Activity，而不是因离开另一Activity 而返回时隐藏软键盘 |
| stateAlwaysHidden  | 始终隐藏软键盘 当 Activity 的主窗口有输入焦点时始终隐藏软键盘 |
| stateVisible       | 显示软键盘 在正常的适宜情况下（当用户向前导航到 Activity 的主窗口时）显示软键盘 |
| stateAlwaysVisible | 显示软键盘 当用户确实是向前导航到 Activity，而不是因离开另一Activity 而返回时. |

2. 在软键盘弹出时，是否需要Activity对此进行调整

|                   |                                                              |
| ----------------- | ------------------------------------------------------------ |
| adjustUnspecified | 主窗口的默认行为，不指定 Activity 的主窗口是否调整尺寸以为软键盘腾出空间，或者窗口内容是否进行平移以在屏幕上显露当前焦点。 系统会根据窗口的内容是否存在任何可滚动其内容的布局视图来自动选择其中一种模式。 如果存在这样的视图，窗口将进行尺寸调整，前提是可通过滚动在较小区域内看到窗口的所有内容。 |
| adjustResize      | 始终调整 Activity 主窗口的尺寸来为屏幕上的软键盘腾出空间。   |
| adjustPan         | 不调整 Activity 主窗口的尺寸来为软键盘腾出空间， 而是**自动平移窗口**的内容，使当前焦点永远不被键盘遮盖，让用户始终都能看到其输入的内容。 这通常不如尺寸调整可取，因为用户可能需要关闭软键盘以到达被遮盖的窗口部分或与这些部分进行交互。 |
| adjustNoting      | 软键盘弹出时，主窗口Activity不会做出任何响应。               |



应用场景

|                   |                                                              |
| ----------------- | ------------------------------------------------------------ |
| adjustUnspecified | 当软键盘弹出时，系统自动指定窗口的调整模式，根据不同的情况会选择adjustResize或者adjustPan的一种。 |
| adjustResize      | 当软键盘弹出时，会将主窗口的平移（translateY），来适应软键盘的显示。 |
| adjustPan         | 当软键盘弹出时，会让布局重新绘制，这种一般适应于带有滑动性质的控制，让其向下滚动，然后适应软键盘的显示。 |
| adjustNoting      | 软键盘弹出时，主窗口不会做出任何反应。                       |





# Android 的工作原理

Android输入系统的工作原理概括来说，就是监控/dev/input/下的所有设备节点， 当某个节点有数据可读时，将数据读出并进行一系列的翻译加工，然后在所有的窗口中寻找合适的事件接收者，并派发给它。





# Android软键盘的显示原理

软键盘其实是一个Dialog

InputMethodService为我们的输入法创建了一个Dialog，并且对某些参数进行了设置，使之能够在底部或者全屏显示。当我们点击输入框时，系统会对当前的主窗口进行调整，以便留出相应的空间来显示该Dialog在底部，或者全屏。

其实这段话我们经常在各种软键盘博客所看到，但时大家并不知道Android是怎么为我们创建的这个Dialog，所以我们先带大家来看下键盘生成这块的源码，了解软键盘的生成流程。

![在这里插入图片描述](https://img-blog.csdnimg.cn/20210118142809604.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0FkcmlhbkFuZHJvaWQ=,size_16,color_FFFFFF,t_70)



```java
@Override public void onCreate() {
    mTheme = Resources.selectSystemTheme(mTheme,
            getApplicationInfo().targetSdkVersion,
            android.R.style.Theme_InputMethod,
            android.R.style.Theme_Holo_InputMethod,
            android.R.style.Theme_DeviceDefault_InputMethod,
            android.R.style.Theme_DeviceDefault_InputMethod);
    super.setTheme(mTheme);
    super.onCreate();
    mImm = (InputMethodManager)getSystemService(INPUT_METHOD_SERVICE);
    mSettingsObserver = SettingsObserver.createAndRegister(this);
    // TODO(b/111364446) Need to address context lifecycle issue if need to re-create
    // for update resources & configuration correctly when show soft input
    // in non-default display.
    mInflater = (LayoutInflater)getSystemService(
            Context.LAYOUT_INFLATER_SERVICE);
    mWindow = new SoftInputWindow(this, "InputMethod", mTheme, null, null, mDispatcherState,
            WindowManager.LayoutParams.TYPE_INPUT_METHOD, Gravity.BOTTOM, false);
    // For ColorView in DecorView to work, FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS needs to be set
    // by default (but IME developers can opt this out later if they want a new behavior).
    mWindow.getWindow().setFlags(
            FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS, FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
    initViews();
    mWindow.getWindow().setLayout(MATCH_PARENT, WRAP_CONTENT);
}
```



**SoftInputWindow.java**

```java
public class SoftInputWindow extends Dialog{

}
```





# 软键盘状态可以设置的值有

1. stateUnspecified

   不显式指定软键盘的状态（隐藏或显示），状态将依赖于主题的设置或者将由系统将选择一个合适的状态；是软键盘状态的默认设置；

2. stateUnchanged

   Activity获得焦点（windowsFocus？）时，软键盘保持前面的状态，无论是隐藏还是显示；

3. stateHidden

   正常情况下，Activity获得焦点**时**，软键盘是隐藏状态（直到用户自己touch文本框）；--窗口打开**时**就会默认**显示软键盘**

4. stateAlwaysHidden

   当该**主窗口**获得焦点**时**，软键盘总是被隐藏；

5. stateVisible

   正常情况下，Activity获得焦点**时**，软键盘是显示状态（如果该窗口需要的话（即有EditText，或有Editable的控件） ）；

6. stateAlwaysVisible

   该主窗体获得焦点**时**，软键盘总是显示状态；



# 窗口状态可以设置的值有

1. adjustUnspecified

   默认设置，不指定**主窗口**是否**调整**以适合软键盘输入，由系统决定干什么；

2. adjustResize

   **调整****主窗口**，也就是挤压窗口界面，将窗口**调整**到软键盘之上；

3. adjustPan

   不**调整**窗口，显示到状态上就是软键盘会覆盖**主窗口**的下半部分





# android软键盘盖住输入框的解决方式

**方法一：在你的activity中的oncreate中setContentView之前写上这个代码**

```
getWindow().setSoftInputMode(WindowManager.LayoutParams.SOFT_INPUT_ADJUST_PAN);（测试失败）
 getWindow().setSoftInputMode(WindowManager.LayoutParams.SOFT_INPUT_ADJUST_RESIZE|WindowManager.LayoutParams.SOFT_INPUT_STATE_HIDDEN);
```

**方法二：**在项目的AndroidManifest.xml文件中界面对应的

```
<activity>
```

里加入android:windowSoftInputMode="stateVisible|adjustResize"，这样会让屏幕整体上移。如果加上的是 android:windowSoftInputMode="adjustPan"这样键盘就会覆盖屏幕。

**方法三：**把顶级的layout替换成ScrollView，或者说在顶级的Layout上面再加一层ScrollView的封装。这样就会把软键盘和输入框一起滚动了，软键盘会一直处于底部。

